{% extends '@LinkORBNebula/module/base.html.twig' %}

{% set isAiPage = wikiPage.id and wikiPage.aiGenerated %}

{% block form_open %}
<form name="{{ form.vars.name }}" method="post" action="{{ form.vars.action }}" id="{{ form.vars.id }}">
{% endblock %}

{% block form_close %}
{% if isAiPage %}
  {# For AI pages, render form_rest hidden since we don't use the content field #}
  <div style="display: none;">{{ form_rest(form) }}</div>
{% else %}
  {{ form_rest(form) }}
{% endif %}
</form>
{% endblock %}

{% block context_header_actions %}
  {% if wikiPage.id %}
    <a href="{{ path('wiki_page_edit_advanced', {'wikiName': wikiPage.wiki.name, 'pageName': wikiPage.name}) }}" class="btn btn-sm btn-outline-primary">
      <i class="icon-lux-settings me-1"></i> Advanced
    </a>
  {% endif %}
{% endblock %}

{% block context_content %}
  {% if isAiPage %}
    {# AI Page: Edit context only #}
    <div class="mb-3">
      <label for="ai_context" class="form-label fw-bold">
        <i class="icon-lux-lightbulb me-1"></i> AI Context
      </label>
      <div class="form-text mb-2">Provide context/instructions for AI content generation (supports Markdown)</div>
      <textarea id="ai_context" name="ai_context" class="form-control" style="display:none;">{{ wikiPage.context }}</textarea>
    </div>
  {% else %}
    {# Regular Page: Edit content #}
    {{ form_widget(form) }}
  {% endif %}
{% endblock %}

{% block details %}
  <h6 class="mb-3"><i class="icon-lux-books me-1"></i> Rich content reference</h6>

  <p class="text-muted small mb-2">
    Wiki pages support <strong>Markdown</strong> and <strong>Twig</strong> expressions for dynamic content.
  </p>

  <div class="mb-3">
    <strong class="small">Including resources</strong>
    <p class="text-muted small mb-1">
      Use <code>resource()</code> to include content from other wiki pages or registered resources:
    </p>
    <pre class="small bg-light p-2 rounded mb-1"><code>{{ '{{ resource("wiki://my-wiki/shared-header") }}' }}</code></pre>
    <p class="text-muted small">
      <a href="{{ path('resource_index') }}"><i class="icon-lux-arrow-square-out me-1"></i>Browse available resources</a>
    </p>
  </div>

  <div class="mb-3">
    <strong class="small">Variables</strong>
    <p class="text-muted small mb-1">
      Access wiki data variables defined in the wiki config:
    </p>
    <pre class="small bg-light p-2 rounded"><code>{{ '{{ data.company_name }}' }}
{{ '{{ data.version }}' }}</code></pre>
  </div>

  <div class="mb-3">
    <strong class="small">Conditionals</strong>
    <pre class="small bg-light p-2 rounded"><code>{{ '{% if data.show_section %}' }}
  Content here
{{ '{% endif %}' }}</code></pre>
  </div>

  <div class="mb-3">
    <strong class="small">Loops</strong>
    <pre class="small bg-light p-2 rounded"><code>{{ '{% for item in data.items %}' }}
  - {{ '{{ item }}' }}
{{ '{% endfor %}' }}</code></pre>
  </div>

  <div class="mb-3">
    <strong class="small">Filters</strong>
    <pre class="small bg-light p-2 rounded"><code>{{ '{{ data.name | upper }}' }}
{{ '{{ data.name | lower }}' }}
{{ '{{ data.items | length }}' }}
{{ '{{ data.items | join(", ") }}' }}
{{ '{{ data.price | number_format(2) }}' }}</code></pre>
  </div>

  <div>
    <strong class="small">Raw blocks</strong>
    <p class="text-muted small mb-1">
      Prevent Twig from processing a section:
    </p>
    <pre class="small bg-light p-2 rounded"><code>{{ '{% verbatim %}' }}
  {{ '{{ not processed }}' }}
{{ '{% endverbatim %}' }}</code></pre>
  </div>
{% endblock %}

{% block context_footer_actions %}
  {% if wikiPage.id and is_granted('delete', wikiPage) %}
    <form action="{{ path('wiki_page_delete', {'wikiName': wikiPage.wiki.name, 'pageName': wikiPage.name}) }}"
          method="post"
          onsubmit="return confirm('Are you sure you want to delete this page?')"
          class="d-inline me-auto">
      <input type="hidden" name="token" value="{{ csrf_token('delete-item') }}">
      <button type="submit" class="btn btn-danger">
        <i class="icon-lux-trash me-1"></i> Delete
      </button>
    </form>
  {% endif %}
  {% if isAiPage %}
    <a href="{{ path('wiki_page_generate_preview', {'wikiName': wikiPage.wiki.name, 'pageName': wikiPage.name}) }}" class="btn btn-outline-secondary me-2" target="_blank" rel="noopener noreferrer">
      <i class="icon-lux-eye me-1"></i> Preview
    </a>
    <button type="submit" name="ai_action" value="save" class="btn btn-outline-primary me-2">
      <i class="icon-lux-check me-1"></i> Save
    </button>
    <button type="submit" name="ai_action" value="generate" class="btn btn-success">
      <i class="icon-lux-lightbulb me-1"></i> Generate
    </button>
  {% else %}
    <button type="submit" class="btn btn-success">
      <i class="icon-lux-check me-1"></i> Save
    </button>
  {% endif %}
{% endblock %}

{% block scripts_custom %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/editor/0.1.0/editor.css">
  <script src="https://cdn.jsdelivr.net/editor/0.1.0/editor.js"></script>
  <script src="https://cdn.jsdelivr.net/editor/0.1.0/marked.js"></script>
  <style>
    .CodeMirror {
      border: 1px solid #ece9e9;
      {% if isAiPage %}
      height: 200px !important;
      {% else %}
      min-height: 400px !important;
      {% endif %}
    }
  </style>

  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
      {% if isAiPage %}
        {# AI Page: Markdown editor for context #}
        var editor = new Editor({
          element: document.getElementById('ai_context'),
        });
        editor.render();

      {% else %}
        {# Regular Page: Markdown editor for content #}
        var editor = new Editor({
          element: document.getElementById('wiki_page_content_content'),
        });
        editor.render();

        var content = editor.codemirror.getValue();
        contentObj = $('#wiki_page_content_content');
        $('<span id="msg" class="ml-2"></span>').insertBefore(contentObj);

        editor.codemirror.on('update', function (cm) {
          (0 == content.localeCompare(editor.codemirror.getValue()))
            ? $('#msg').html('').fadeIn(1600)
            : $('#msg').html('<label class="text-danger">(modified)</label>').fadeIn(1600);
        });

        $(document).keydown(function (event) {
          if ((event.ctrlKey || event.metaKey) && event.which == 83) {
            event.preventDefault();

            var form = $(contentObj).closest('form');
            $.ajax({
              url: form.attr('action'),
              type: form.attr('method'),
              contentType: 'application/json',
              data: JSON.stringify({content: editor.codemirror.getValue()}),
              success: function (html) {
                $('#msg').html('<label class="text-success">(Saved)</label>').fadeOut(1600);
                content = editor.codemirror.getValue();
              }
            });
          };
        });
      {% endif %}
    });
  </script>
{% endblock %}
