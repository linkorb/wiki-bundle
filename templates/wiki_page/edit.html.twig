{% extends '@LinkORBNebula/module/base.html.twig' %}

{% block context_header_actions %}
  {% if wikiPage.id %}
    <a href="{{ path('wiki_page_edit_advanced', {'wikiName': wikiPage.wiki.name, 'pageName': wikiPage.name}) }}" class="btn btn-sm btn-outline-primary">
      <i class="icon-lux-settings me-1"></i> Advanced
    </a>
  {% endif %}
{% endblock %}

{% block context_content %}
  {{ form_start(form) }}
    {{ form_widget(form) }}
  {{ form_end(form) }}
{% endblock %}

{% block context_footer_actions %}
  <div class="d-flex justify-content-between w-100">
    <div>
      {% if wikiPage.id and is_granted('delete', wikiPage) %}
        <form action="{{ path('wiki_page_delete', {'wikiName': wikiPage.wiki.name, 'pageName': wikiPage.name}) }}"
              method="post"
              onsubmit="return confirm('Are you sure you want to delete this page?')"
              class="d-inline">
          <input type="hidden" name="token" value="{{ csrf_token('delete-item') }}">
          <button type="submit" class="btn btn-danger">
            <i class="icon-lux-trash me-1"></i> Delete
          </button>
        </form>
      {% endif %}
    </div>
    <div>
      <button type="submit" form="{{ form.vars.id }}" class="btn btn-success">
        <i class="icon-lux-check me-1"></i> {{ button_label|default('Save') }}
      </button>
    </div>
  </div>
{% endblock %}

{% block scripts_custom %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/editor/0.1.0/editor.css">
  <script src="https://cdn.jsdelivr.net/editor/0.1.0/editor.js"></script>
  <script src="https://cdn.jsdelivr.net/editor/0.1.0/marked.js"></script>
  <style>
    .CodeMirror {
      border: 1px solid #ece9e9;
      min-height: 400px !important;
    }
  </style>
  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
      var editor = new Editor({
        element: document.getElementById('wiki_page_content_content'),
      })
      editor.render();

      var content = editor.codemirror.getValue();
      contentObj = $('#wiki_page_content_content');
      $('<span id="msg" class="ml-2"></span>').insertBefore(contentObj);

      editor.codemirror.on('update', function (cm) {
        (0 == content.localeCompare(editor.codemirror.getValue()))
          ? $('#msg').html('').fadeIn(1600)
          : $('#msg').html('<label class="text-danger">(modified)</label>').fadeIn(1600);
      });

      $(document).keydown(function (event) {
        if ((event.ctrlKey || event.metaKey) && event.which == 83) {
          event.preventDefault();

          var form = $(contentObj).closest('form');
          $.ajax({
            url: form.attr('action'),
            type: form.attr('method'),
            data: JSON.stringify({content: editor.codemirror.getValue()}),
            success: function (html) {
              $('#msg').html('<label class="text-success">(Saved)</label>').fadeOut(1600);
              content = editor.codemirror.getValue();
            }
          });
        };
      });
    });
  </script>
{% endblock %}
